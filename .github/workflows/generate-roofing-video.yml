name: Generate Business Video (Dynamic)

on:
  repository_dispatch:
    types: [generate-roofing-video, generate-business-video]
  workflow_dispatch:
    inputs:
      business_name:
        description: 'Business name'
        required: true
        type: string
      website_url:
        description: 'Company website URL'
        required: false
        type: string
      business_city:
        description: 'Business city'
        required: false
        type: string
      business_phone:
        description: 'Business phone number'
        required: false
        type: string
      business_email:
        description: 'Business email'
        required: false
        type: string
      industry:
        description: 'Business industry'
        required: false
        type: string

jobs:
  generate-business-video:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
        
      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          npm install
          
          # Install FFmpeg for video processing
          echo "üé• Installing FFmpeg..."
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          
          # Install additional system packages for Puppeteer
          sudo apt-get install -y \
            libasound2t64 \
            libatk-bridge2.0-0 \
            libgtk-3-0 \
            libx11-xcb1 \
            xvfb
          
          # Verify installations
          echo "üîç Verifying installations..."
          node --version
          npm --version
          ffmpeg -version
          
          # Verify critical dependencies
          echo "üîç Verifying critical dependencies..."
          node -e "console.log('Puppeteer:', require('puppeteer').version || 'installed')"
          node -e "console.log('Express:', require('express').version || 'installed')"
          
      - name: Extract business data
        id: business_data
        run: |
          echo "üìä Extracting business data..."
          
          # Extract data from either workflow_dispatch or repository_dispatch
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BUSINESS_NAME="${{ inputs.business_name }}"
            WEBSITE_URL="${{ inputs.website_url }}"
            BUSINESS_CITY="${{ inputs.business_city }}"
            BUSINESS_PHONE="${{ inputs.business_phone }}"
            BUSINESS_EMAIL="${{ inputs.business_email }}"
            INDUSTRY="${{ inputs.industry }}"
            WEBSITE_HTML_BASE64=""
          else
            BUSINESS_NAME="${{ github.event.client_payload.business_name }}"
            WEBSITE_URL="${{ github.event.client_payload.WEBSITE_URL }}"
            BUSINESS_CITY="${{ github.event.client_payload.business_city }}"
            BUSINESS_PHONE="${{ github.event.client_payload.business_phone }}"
            BUSINESS_EMAIL="${{ github.event.client_payload.business_email }}"
            INDUSTRY="${{ github.event.client_payload.industry }}"
            HTML_FILENAME="${{ github.event.client_payload.html_filename }}"
            HTML_SIZE="${{ github.event.client_payload.html_size }}"
            WEBSITE_HTML_BASE64="${{ github.event.client_payload.WEBSITE_HTML_BASE64 }}"
          fi
          
          # Set dynamic defaults (no more hardcoded Dutch roofing!)
          BUSINESS_NAME="${BUSINESS_NAME:-Business}"
          WEBSITE_URL="${WEBSITE_URL:-}"
          BUSINESS_CITY="${BUSINESS_CITY:-City}"
          BUSINESS_PHONE="${BUSINESS_PHONE:-}"
          BUSINESS_EMAIL="${BUSINESS_EMAIL:-}"
          INDUSTRY="${INDUSTRY:-general}"
          WEBSITE_HTML_BASE64="${WEBSITE_HTML_BASE64:-}"
          
          # Create dynamic artifact name based on actual industry
          SANITIZED_NAME=$(echo "$BUSINESS_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
          ARTIFACT_NAME="${INDUSTRY}-video-${SANITIZED_NAME}"
          
          # Limit length to 100 characters
          if [ ${#ARTIFACT_NAME} -gt 100 ]; then
            ARTIFACT_NAME="${ARTIFACT_NAME:0:100}"
          fi
          
          # Set outputs
          echo "business_name=$BUSINESS_NAME" >> $GITHUB_OUTPUT
          echo "website_url=$WEBSITE_URL" >> $GITHUB_OUTPUT
          echo "business_city=$BUSINESS_CITY" >> $GITHUB_OUTPUT
          echo "business_phone=$BUSINESS_PHONE" >> $GITHUB_OUTPUT
          echo "business_email=$BUSINESS_EMAIL" >> $GITHUB_OUTPUT
          echo "industry=$INDUSTRY" >> $GITHUB_OUTPUT
          echo "html_filename=$HTML_FILENAME" >> $GITHUB_OUTPUT
          echo "html_size=$HTML_SIZE" >> $GITHUB_OUTPUT
          echo "website_html_base64=$WEBSITE_HTML_BASE64" >> $GITHUB_OUTPUT
          echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Business data extracted:"
          echo "  üè¢ Company: $BUSINESS_NAME"
          echo "  üèôÔ∏è City: $BUSINESS_CITY"
          echo "  üè≠ Industry: $INDUSTRY"
          echo "  üìÑ HTML File: $HTML_FILENAME"
          echo "  üìä HTML Size: $HTML_SIZE bytes"
          echo "  üì¶ Artifact: $ARTIFACT_NAME"
          
      - name: Process website content
        run: |
          echo "üìÑ Processing website content..."
          
          BUSINESS_NAME="${{ steps.business_data.outputs.business_name }}"
          BUSINESS_CITY="${{ steps.business_data.outputs.business_city }}"
          BUSINESS_PHONE="${{ steps.business_data.outputs.business_phone }}"
          BUSINESS_EMAIL="${{ steps.business_data.outputs.business_email }}"
          INDUSTRY="${{ steps.business_data.outputs.industry }}"
          
          # Get HTML filename from repository dispatch payload
          HTML_FILENAME="${{ github.event.client_payload.html_filename }}"
          HTML_SIZE_EXPECTED="${{ github.event.client_payload.html_size }}"
          
          # Try to get HTML content
          HTML_SUCCESS=false
          
          # Primary Strategy: Download uploaded HTML file from repository
          if [ -n "$HTML_FILENAME" ] && [ "$HTML_FILENAME" != "null" ]; then
            echo "üì• Downloading HTML file: $HTML_FILENAME"
            echo "üìä Expected size: $HTML_SIZE_EXPECTED bytes"
            
            # Try to download from temp-html directory
            echo "üîç Attempting to download from temp-html/$HTML_FILENAME..."
            
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/contents/temp-html/$HTML_FILENAME")
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
            
            if [ "$HTTP_STATUS" = "200" ]; then
              # Extract and decode the content
              echo "$RESPONSE" | grep -v "HTTP_STATUS:" | jq -r '.content' | base64 -d > website.html
              
              if [ -s website.html ]; then
                HTML_SIZE=$(wc -c < website.html)
                echo "‚úÖ Downloaded HTML content: $HTML_SIZE bytes"
                echo "üéØ Using actual uploaded HTML from n8n!"
                HTML_SUCCESS=true
              else
                echo "‚ùå Failed to decode HTML content"
              fi
            else
              echo "‚ùå Failed to download HTML file (HTTP $HTTP_STATUS)"
              echo "üìã Response: $(echo "$RESPONSE" | grep -v "HTTP_STATUS:" | jq -r '.message // "Unknown error"' 2>/dev/null)"
            fi
          fi
          
          # Fallback: Check if file was already committed to repo
          if [ "$HTML_SUCCESS" = "false" ] && [ -n "$HTML_FILENAME" ]; then
            echo "üîç Checking if HTML file exists in repository root..."
            if [ -f "$HTML_FILENAME" ]; then
              cp "$HTML_FILENAME" website.html
              HTML_SIZE=$(wc -c < website.html)
              echo "‚úÖ Found HTML file locally: $HTML_SIZE bytes"
              HTML_SUCCESS=true
            fi
          fi
          
          # Strategy 3: Create COMPLETELY DYNAMIC template (no more Dutch roofing!)
          if [ "$HTML_SUCCESS" = "false" ]; then
            echo "üìÑ Creating 100% dynamic template for: $BUSINESS_NAME"
            echo "üè≠ Industry: $INDUSTRY"
            echo "üìç Location: $BUSINESS_CITY"
            
            # Set industry-specific content based on the ACTUAL data received
            case "$INDUSTRY" in
              "real_estate")
                PRIMARY_COLOR="#1e3a8a"
                SECONDARY_COLOR="#dc2626"
                TAGLINE="Professional Real Estate Services"
                SERVICE1="üè† Property Sales"
                SERVICE2="üè¢ Commercial Real Estate" 
                SERVICE3="üè° Residential Listings"
                SERVICE4="üíº Investment Properties"
                SERVICE5="üìä Market Analysis"
                SERVICE6="üîë Property Management"
                ;;
              "hvac")
                PRIMARY_COLOR="#dc2626"
                SECONDARY_COLOR="#1e40af"
                TAGLINE="Professional HVAC Services"
                SERVICE1="üî• Heating Systems"
                SERVICE2="‚ùÑÔ∏è Air Conditioning"
                SERVICE3="üîß HVAC Repair"
                SERVICE4="üõ†Ô∏è Maintenance"
                SERVICE5="üí® Air Quality"
                SERVICE6="‚ö° Emergency Service"
                ;;
              "restaurant")
                PRIMARY_COLOR="#dc2626"
                SECONDARY_COLOR="#92400e"
                TAGLINE="Exceptional Dining Experience"
                SERVICE1="üçΩÔ∏è Fine Dining"
                SERVICE2="ü•ò Catering Services"
                SERVICE3="üçï Delivery & Takeout"
                SERVICE4="üéâ Private Events"
                SERVICE5="üç∑ Bar & Cocktails"
                SERVICE6="‚òï Coffee & Desserts"
                ;;
              "roofing")
                PRIMARY_COLOR="#1e40af"
                SECONDARY_COLOR="#dc2626"
                TAGLINE="Professional Roofing Services"
                SERVICE1="üè† Roof Installation"
                SERVICE2="üîß Roof Repair"
                SERVICE3="üõ°Ô∏è Roof Maintenance"
                SERVICE4="üåßÔ∏è Gutter Services"
                SERVICE5="üî• Roof Insulation"
                SERVICE6="‚ö° Emergency Repairs"
                ;;
              *)
                # Default to generic business services
                PRIMARY_COLOR="#1f2937"
                SECONDARY_COLOR="#3b82f6"
                TAGLINE="Professional Business Services"
                SERVICE1="‚≠ê Premium Service"
                SERVICE2="üîß Expert Solutions"
                SERVICE3="üíº Business Consulting"
                SERVICE4="üìû Customer Support"
                SERVICE5="üöÄ Innovation"
                SERVICE6="‚úÖ Quality Assurance"
                ;;
            esac
            
            # Create dynamic HTML with ACTUAL business data
            cat > website.html << 'HTML_EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>BUSINESS_NAME_PLACEHOLDER - TAGLINE_PLACEHOLDER</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body { 
                      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif; 
                      line-height: 1.6; 
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      color: #1f2937;
                  }
                  .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
                  .header { 
                      background: rgba(255,255,255,0.95);
                      padding: 120px 0; 
                      text-align: center; 
                      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
                      backdrop-filter: blur(10px);
                  }
                  .header h1 { 
                      font-size: 5em; 
                      color: PRIMARY_COLOR_PLACEHOLDER; 
                      margin-bottom: 30px;
                      text-shadow: 2px 2px 8px rgba(0,0,0,0.1);
                      font-weight: 800;
                      letter-spacing: -2px;
                  }
                  .tagline { 
                      font-size: 2.2em; 
                      color: SECONDARY_COLOR_PLACEHOLDER; 
                      font-weight: 300;
                      margin-bottom: 20px;
                  }
                  .location {
                      font-size: 1.6em;
                      color: #6b7280;
                      margin-bottom: 40px;
                      font-weight: 500;
                  }
                  .hero-stats {
                      display: flex;
                      justify-content: center;
                      gap: 60px;
                      margin-top: 50px;
                      flex-wrap: wrap;
                  }
                  .stat {
                      text-align: center;
                      background: rgba(0,0,0,0.05);
                      padding: 30px 40px;
                      border-radius: 20px;
                      min-width: 200px;
                      backdrop-filter: blur(10px);
                  }
                  .stat-number {
                      font-size: 3.5em;
                      font-weight: 900;
                      color: SECONDARY_COLOR_PLACEHOLDER;
                      display: block;
                      line-height: 1;
                  }
                  .stat-label {
                      color: #6b7280;
                      font-size: 1.1em;
                      margin-top: 10px;
                      font-weight: 600;
                  }
                  .content { 
                      background: white; 
                      margin: 60px 0; 
                      padding: 80px 60px;
                      border-radius: 30px;
                      box-shadow: 0 30px 80px rgba(0,0,0,0.1);
                  }
                  h2 { 
                      color: PRIMARY_COLOR_PLACEHOLDER; 
                      font-size: 3.5em; 
                      margin-bottom: 50px; 
                      text-align: center;
                      font-weight: 700;
                      letter-spacing: -1px;
                  }
                  .services { 
                      display: grid; 
                      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); 
                      gap: 40px; 
                      margin: 60px 0; 
                  }
                  .service { 
                      background: linear-gradient(135deg, PRIMARY_COLOR_PLACEHOLDER 0%, SECONDARY_COLOR_PLACEHOLDER 100%);
                      color: white;
                      padding: 50px 40px; 
                      border-radius: 25px; 
                      text-align: center;
                      transition: all 0.4s ease;
                      box-shadow: 0 15px 40px rgba(0,0,0,0.15);
                  }
                  .service:hover { 
                      transform: translateY(-20px) scale(1.02); 
                      box-shadow: 0 30px 70px rgba(0,0,0,0.25);
                  }
                  .service h3 { 
                      font-size: 2em; 
                      margin-bottom: 20px; 
                      font-weight: 700;
                  }
                  .service p { 
                      font-size: 1.2em; 
                      opacity: 0.95; 
                      line-height: 1.6;
                      font-weight: 400;
                  }
                  .contact-section { 
                      background: linear-gradient(135deg, PRIMARY_COLOR_PLACEHOLDER 0%, SECONDARY_COLOR_PLACEHOLDER 100%);
                      color: white;
                      padding: 100px 60px;
                      border-radius: 30px;
                      text-align: center;
                      margin: 60px 0;
                      box-shadow: 0 30px 80px rgba(0,0,0,0.2);
                  }
                  .contact-section h2 {
                      color: white;
                      margin-bottom: 30px;
                  }
                  .contact-intro {
                      font-size: 1.4em;
                      margin-bottom: 50px;
                      opacity: 0.95;
                      font-weight: 300;
                  }
                  .contact-info { 
                      display: grid; 
                      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
                      gap: 40px; 
                      margin-top: 50px;
                  }
                  .contact-item { 
                      background: rgba(255,255,255,0.15);
                      padding: 40px;
                      border-radius: 20px;
                      backdrop-filter: blur(20px);
                      border: 1px solid rgba(255,255,255,0.2);
                      transition: all 0.3s ease;
                  }
                  .contact-item:hover {
                      background: rgba(255,255,255,0.25);
                      transform: translateY(-5px);
                  }
                  .contact-item h4 { 
                      font-size: 1.6em; 
                      margin-bottom: 15px; 
                      font-weight: 600;
                  }
                  .contact-item p { 
                      font-size: 1.3em; 
                      font-weight: 500;
                      opacity: 0.95;
                  }
                  @media (max-width: 768px) {
                      .header h1 { font-size: 3em; }
                      .tagline { font-size: 1.6em; }
                      .hero-stats { gap: 30px; }
                      .stat { min-width: 150px; padding: 20px; }
                      .content { padding: 40px 30px; }
                      .services { grid-template-columns: 1fr; gap: 30px; }
                      .service { padding: 40px 30px; }
                      .contact-section { padding: 60px 30px; }
                      h2 { font-size: 2.5em; }
                  }
              </style>
          </head>
          <body>
              <div class="header">
                  <div class="container">
                      <h1>BUSINESS_NAME_PLACEHOLDER</h1>
                      <p class="tagline">TAGLINE_PLACEHOLDER</p>
                      <p class="location">üìç Serving BUSINESS_CITY_PLACEHOLDER</p>
                      <div class="hero-stats">
                          <div class="stat">
                              <span class="stat-number">20+</span>
                              <span class="stat-label">Years Experience</span>
                          </div>
                          <div class="stat">
                              <span class="stat-number">500+</span>
                              <span class="stat-label">Happy Clients</span>
                          </div>
                          <div class="stat">
                              <span class="stat-number">100%</span>
                              <span class="stat-label">Satisfaction</span>
                          </div>
                      </div>
                  </div>
              </div>
              
              <div class="container">
                  <div class="content">
                      <h2>Our Services</h2>
                      <div class="services">
                          <div class="service">
                              <h3>SERVICE1_PLACEHOLDER</h3>
                              <p>Professional and reliable service delivered with expertise and attention to detail.</p>
                          </div>
                          <div class="service">
                              <h3>SERVICE2_PLACEHOLDER</h3>
                              <p>Expert solutions tailored to meet your specific needs and requirements.</p>
                          </div>
                          <div class="service">
                              <h3>SERVICE3_PLACEHOLDER</h3>
                              <p>Comprehensive service offerings with guaranteed satisfaction and quality.</p>
                          </div>
                          <div class="service">
                              <h3>SERVICE4_PLACEHOLDER</h3>
                              <p>Advanced solutions designed to deliver exceptional results and value.</p>
                          </div>
                          <div class="service">
                              <h3>SERVICE5_PLACEHOLDER</h3>
                              <p>Specialized expertise to address complex challenges and opportunities.</p>
                          </div>
                          <div class="service">
                              <h3>SERVICE6_PLACEHOLDER</h3>
                              <p>Premium service options with dedicated support and professional excellence.</p>
                          </div>
                      </div>
                  </div>
                  
                  <div class="contact-section">
                      <h2>Get In Touch</h2>
                      <p class="contact-intro">Ready to work with BUSINESS_NAME_PLACEHOLDER? Contact us today for professional service you can trust.</p>
                      <div class="contact-info">
                          CONTACT_ITEMS_PLACEHOLDER
                      </div>
                  </div>
              </div>
          </body>
          </html>
          HTML_EOF
            
            # Replace placeholders with actual data (using | as delimiter to avoid conflicts with /)
            sed -i "s|BUSINESS_NAME_PLACEHOLDER|$BUSINESS_NAME|g" website.html
            sed -i "s|BUSINESS_CITY_PLACEHOLDER|$BUSINESS_CITY|g" website.html
            sed -i "s|TAGLINE_PLACEHOLDER|$TAGLINE|g" website.html
            sed -i "s|PRIMARY_COLOR_PLACEHOLDER|$PRIMARY_COLOR|g" website.html
            sed -i "s|SECONDARY_COLOR_PLACEHOLDER|$SECONDARY_COLOR|g" website.html
            sed -i "s|SERVICE1_PLACEHOLDER|$SERVICE1|g" website.html
            sed -i "s|SERVICE2_PLACEHOLDER|$SERVICE2|g" website.html
            sed -i "s|SERVICE3_PLACEHOLDER|$SERVICE3|g" website.html
            sed -i "s|SERVICE4_PLACEHOLDER|$SERVICE4|g" website.html
            sed -i "s|SERVICE5_PLACEHOLDER|$SERVICE5|g" website.html
            sed -i "s|SERVICE6_PLACEHOLDER|$SERVICE6|g" website.html
            
            # Add contact information dynamically
            CONTACT_ITEMS=""
            if [ -n "$BUSINESS_PHONE" ] && [ "$BUSINESS_PHONE" != "null" ]; then
              CONTACT_ITEMS="$CONTACT_ITEMS<div class=\"contact-item\"><h4>üìû Phone</h4><p>$BUSINESS_PHONE</p></div>"
            fi
            if [ -n "$BUSINESS_EMAIL" ] && [ "$BUSINESS_EMAIL" != "null" ]; then
              CONTACT_ITEMS="$CONTACT_ITEMS<div class=\"contact-item\"><h4>üìß Email</h4><p>$BUSINESS_EMAIL</p></div>"
            fi
            CONTACT_ITEMS="$CONTACT_ITEMS<div class=\"contact-item\"><h4>üìç Location</h4><p>$BUSINESS_CITY</p></div>"
            
            # Escape special characters for sed
            CONTACT_ITEMS_ESCAPED=$(echo "$CONTACT_ITEMS" | sed 's/[[\.*^$()+?{|]/\\&/g')
            sed -i "s|CONTACT_ITEMS_PLACEHOLDER|$CONTACT_ITEMS_ESCAPED|g" website.html
            
            echo "‚úÖ Created dynamic $INDUSTRY template for $BUSINESS_NAME in $BUSINESS_CITY"
            echo "üé® Colors: Primary $PRIMARY_COLOR, Secondary $SECONDARY_COLOR"
            HTML_SUCCESS=true
          fi
          
          if [ "$HTML_SUCCESS" = "true" ]; then
            HTML_SIZE=$(wc -c < website.html)
            echo "üìÑ Final HTML ready: $HTML_SIZE bytes"
            echo "üéØ Business: $BUSINESS_NAME"
            echo "üè≠ Industry: $INDUSTRY"
            echo "üìç Location: $BUSINESS_CITY"
          else
            echo "‚ùå Failed to create HTML content"
            exit 1
          fi
          
      - name: Generate video
        continue-on-error: true
        run: |
          echo "üé¨ Starting video generation for ${{ steps.business_data.outputs.business_name }}..."
          
          BUSINESS_NAME="${{ steps.business_data.outputs.business_name }}"
          INDUSTRY="${{ steps.business_data.outputs.industry }}"
          
          # Create videos directory
          mkdir -p videos
          
          # Start the server
          echo "üöÄ Starting video generation server..."
          node server-roofing-simple.js > server.log 2>&1 &
          SERVER_PID=$!
          
          # Wait for server to start
          echo "‚è≥ Waiting for server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:3030/health > /dev/null 2>&1; then
              echo "‚úÖ Server started successfully!"
              break
            fi
            echo "‚è≥ Attempt $i/30..."
            sleep 2
          done
          
          # Check if server is running
          if ! curl -s http://localhost:3030/health > /dev/null 2>&1; then
            echo "‚ùå Server failed to start"
            echo "üìã Server logs:"
            cat server.log || echo "No logs available"
            exit 1
          fi
          
          # Read HTML content
          HTML_CONTENT=$(cat website.html)
          
          # Create JSON payload using jq for safe JSON encoding
          echo "üìã Creating JSON payload..."
          jq -n \
            --arg business_name "$BUSINESS_NAME" \
            --arg html_content "$HTML_CONTENT" \
            --arg industry "$INDUSTRY" \
            '{
              business_name: $business_name,
              html_content: $html_content,
              industry: $industry
            }' > payload.json
          
          echo "üìã Sending request to video server..."
          echo "üìä Business: $BUSINESS_NAME"
          echo "üè≠ Industry: $INDUSTRY"
          echo "üìä HTML Size: ${#HTML_CONTENT} characters"
          
          # Make API call with separated output
          echo "üîç Making API call (600 second timeout for TRUE 1080p60 generation)..."
          
          # Separate curl verbose output from response (10 minute timeout for 1080 frames at 1080p60)
          timeout 600s curl -X POST http://localhost:3030/generate-video \
            -H "Content-Type: application/json" \
            -d @payload.json \
            -o /tmp/response.json \
            -w "%{http_code}" \
            -v 2> /tmp/curl_verbose.txt > /tmp/http_code.txt
          
          CURL_EXIT_CODE=$?
          HTTP_CODE=$(cat /tmp/http_code.txt 2>/dev/null || echo "000")
          
          echo "üîç Curl exit code: $CURL_EXIT_CODE"
          echo "üìä HTTP Status: $HTTP_CODE"
          
          if [ -f /tmp/curl_verbose.txt ]; then
            echo "üîç Curl verbose output:"
            cat /tmp/curl_verbose.txt
          fi
          
          if [ -f /tmp/response.json ]; then
            echo "üìä Response body:"
            cat /tmp/response.json
          fi
          
          # Always show server logs for debugging
          echo "üìã Server logs (last 20 lines):"
          tail -20 server.log 2>/dev/null || echo "No server logs"
          
          # Cleanup
          kill $SERVER_PID 2>/dev/null || true
          rm -f payload.json website.html /tmp/response.json /tmp/curl_verbose.txt /tmp/http_code.txt
          
          echo "‚úÖ Video generation step completed (exit code: $CURL_EXIT_CODE)"
          
      - name: Check for Generated Videos
        id: check_videos
        if: always()
        run: |
          echo "üîç Checking for generated video files..."
          
          if [ -d "videos" ] && [ "$(ls -A videos/ 2>/dev/null)" ]; then
            echo "‚úÖ Video files found:"
            ls -la videos/
            
            # Find the most recent video file
            LATEST_VIDEO=$(ls -t videos/*.mp4 2>/dev/null | head -1 || echo "")
            
            if [ -n "$LATEST_VIDEO" ]; then
              VIDEO_NAME=$(basename "$LATEST_VIDEO")
              VIDEO_SIZE=$(du -h "$LATEST_VIDEO" | cut -f1)
              VIDEO_SIZE_BYTES=$(stat -c%s "$LATEST_VIDEO" 2>/dev/null || stat -f%z "$LATEST_VIDEO" 2>/dev/null || echo "0")
              
              echo "üìÅ Latest video: $VIDEO_NAME"
              echo "üìä Size: $VIDEO_SIZE ($VIDEO_SIZE_BYTES bytes)"
              
              # Check if it's a real video file (at least 100KB)
              if [ "$VIDEO_SIZE_BYTES" -gt 100000 ]; then
                echo "‚úÖ Video file appears valid"
                echo "has_video=true" >> $GITHUB_OUTPUT
                echo "video_name=$VIDEO_NAME" >> $GITHUB_OUTPUT
                echo "video_size=$VIDEO_SIZE" >> $GITHUB_OUTPUT
              else
                echo "‚ö†Ô∏è Video file too small, might be corrupted"
                echo "has_video=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "‚ùå No MP4 files found"
              echo "has_video=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå No videos directory or empty"
            echo "has_video=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push video to repository
        if: steps.check_videos.outputs.has_video == 'true'
        run: |
          echo "=== Committing Video to Repository ==="

          # Get the HTML filename to create matching video name
          HTML_FILENAME="${{ steps.business_data.outputs.html_filename }}"

          if [ -n "$HTML_FILENAME" ]; then
            # Extract base filename without extension
            BASE_FILENAME="${HTML_FILENAME%.html}"

            # Find the most recent MP4 file
            VIDEO_FILE=$(ls -t videos/*.mp4 2>/dev/null | head -1)

            if [ -n "$VIDEO_FILE" ]; then
              # Rename to match HTML filename
              mv "$VIDEO_FILE" "videos/${BASE_FILENAME}.mp4"
              echo "‚úÖ Renamed video to: videos/${BASE_FILENAME}.mp4"

              # Configure git
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"

              # Add and commit the video
              git add videos/

              if git diff --staged --quiet; then
                echo "‚ö†Ô∏è No changes to commit"
              else
                git commit -m "Add video tour: ${{ steps.business_data.outputs.business_name }}"
                echo "‚úÖ Video committed successfully"

                # Pull latest changes (in case another workflow pushed)
                git pull origin main --rebase
                echo "‚úÖ Synced with remote"

                # Push to repository
                git push
                echo "‚úÖ Video pushed to repository"
                echo "üì∫ Video URL: https://echris6.github.io/Website-Generator/videos/${BASE_FILENAME}.mp4"
              fi
            else
              echo "‚ö†Ô∏è No video file found to commit"
            fi
          else
            echo "‚ö†Ô∏è No HTML filename provided, skipping rename and commit"
          fi

          echo "=== Video Commit Complete ==="

      - name: Upload video artifact
        if: always() && steps.check_videos.outputs.has_video == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.business_data.outputs.artifact_name }}
          path: videos/*.mp4
          retention-days: 30
          if-no-files-found: warn
        
      - name: Workflow summary
        if: always()
        run: |
          echo "## üé¨ Video Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_videos.outputs.has_video }}" == "true" ]; then
            echo "### ‚úÖ SUCCESS: Video Generated!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| üìÅ **File** | ${{ steps.check_videos.outputs.video_name }} |" >> $GITHUB_STEP_SUMMARY
            echo "| üìä **Size** | ${{ steps.check_videos.outputs.video_size }} |" >> $GITHUB_STEP_SUMMARY
            echo "| üè¢ **Business** | ${{ steps.business_data.outputs.business_name }} |" >> $GITHUB_STEP_SUMMARY
            echo "| üè≠ **Industry** | ${{ steps.business_data.outputs.industry }} |" >> $GITHUB_STEP_SUMMARY
            echo "| üìç **Location** | ${{ steps.business_data.outputs.business_city }} |" >> $GITHUB_STEP_SUMMARY
            echo "| üì¶ **Artifact** | ${{ steps.business_data.outputs.artifact_name }} |" >> $GITHUB_STEP_SUMMARY
            echo "| üé¨ **Duration** | 18 seconds (2s pause + 16s scroll) |" >> $GITHUB_STEP_SUMMARY
            echo "| üéûÔ∏è **Format** | TRUE 60 FPS Full HD, 1920x1080 |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üì• Download" >> $GITHUB_STEP_SUMMARY
            echo "Click the **Artifacts** section below to download your video." >> $GITHUB_STEP_SUMMARY
            
            # Also log to console
            echo "‚úÖ Video generation successful!"
            echo "üìÅ Video: ${{ steps.check_videos.outputs.video_name }}"
            echo "üè¢ Business: ${{ steps.business_data.outputs.business_name }}"
          else
            echo "### ‚ùå No Video Generated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The workflow completed but no video file was found." >> $GITHUB_STEP_SUMMARY
            echo "Check the **Generate video** step logs for details." >> $GITHUB_STEP_SUMMARY
            
            # Also log to console
            echo "‚ùå No video file was generated"
            echo "Check the logs above for details"
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated on $(date)*" >> $GITHUB_STEP_SUMMARY
